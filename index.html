<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Endless Runner Dodger Enhanced Phase 1</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      user-select: none;
      overflow: hidden;
      text-align: center;
    }
    canvas {
      display: block;
      margin: 20px auto;
      background: #222;
      border: 2px solid #fff;
      touch-action: none;
    }
    #ui {
      margin: 0 auto;
      width: 400px;
      position: relative;
    }
    #startScreen, #gameOverScreen {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      color: white;
    }
    button {
      padding: 10px 20px;
      font-size: 1.2rem;
      margin-top: 15px;
      cursor: pointer;
      background: #0a0;
      border: none;
      color: white;
      border-radius: 5px;
      user-select: none;
    }
    button:active {
      background: #070;
    }
    #controlsMobile {
      margin-top: 10px;
      display: none;
      justify-content: center;
      gap: 20px;
    }
    #controlsMobile button {
      background: #444;
      width: 80px;
      height: 80px;
      border-radius: 10px;
      font-size: 2rem;
      user-select: none;
    }
    #soundToggle {
      position: absolute;
      top: 5px;
      right: 10px;
      background: #444;
      border: none;
      color: white;
      font-size: 1rem;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
      z-index: 20;
    }
  </style>
</head>
<body>
  <div id="ui" style="position:relative;">
    <canvas id="game" width="400" height="600"></canvas>

    <div id="startScreen">
      <h1>Endless Runner Dodger</h1>
      <p>Dodge the red obstacles!</p>
      <p>Use Left/Right arrows or buttons below (mobile)</p>
      <p>Collect green ‚ö° power-ups for speed boost</p>
      <p>New power-ups: üõ° Shield, üí£ Nuke, ‚è≥ Slow Time</p>
      <button id="startBtn">Start Game</button>
    </div>

    <div id="gameOverScreen" style="display:none;">
      <h1>Game Over</h1>
      <p id="finalScore"></p>
      <p id="bestScore"></p>
      <button id="restartBtn">Restart</button>
    </div>

    <div id="controlsMobile">
      <button id="leftBtn">&#8592;</button>
      <button id="rightBtn">&#8594;</button>
    </div>

    <button id="soundToggle">üîä Mute</button>

    <p id="score">Score: 0</p>
  </div>

  <!-- Sounds -->
  <audio id="moveSound" src="https://freesound.org/data/previews/146/146726_2437358-lq.mp3" preload="auto"></audio>
  <audio id="collisionSound" src="https://freesound.org/data/previews/174/174027_3247037-lq.mp3" preload="auto"></audio>
  <audio id="powerupSound" src="https://freesound.org/data/previews/146/146728_2437358-lq.mp3" preload="auto"></audio>
  <audio id="shieldSound" src="https://freesound.org/data/previews/106/106767_512123-lq.mp3" preload="auto"></audio>
  <audio id="nukeSound" src="https://freesound.org/data/previews/264/264222_512123-lq.mp3" preload="auto"></audio>
  <audio id="slowSound" src="https://freesound.org/data/previews/240/240777_512123-lq.mp3" preload="auto"></audio>

  <script>
    // ==== Setup ====
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // UI elements
    const startScreen = document.getElementById('startScreen');
    const startBtn = document.getElementById('startBtn');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const finalScoreDisplay = document.getElementById('finalScore');
    const bestScoreDisplay = document.getElementById('bestScore');
    const restartBtn = document.getElementById('restartBtn');
    const scoreDisplay = document.getElementById('score');
    const controlsMobile = document.getElementById('controlsMobile');
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    const soundToggle = document.getElementById('soundToggle');

    // Sounds
    const moveSound = document.getElementById('moveSound');
    const collisionSound = document.getElementById('collisionSound');
    const powerupSound = document.getElementById('powerupSound');
    const shieldSound = document.getElementById('shieldSound');
    const nukeSound = document.getElementById('nukeSound');
    const slowSound = document.getElementById('slowSound');

    // Game variables
    const player = {
      x: canvas.width / 2 - 15,
      y: canvas.height - 60,
      width: 30,
      height: 30,
      speed: 7,
      dx: 0,
      displayX: canvas.width / 2 - 15,
      speedBoostActive: false,
      speedBoostTimer: 0,
      shieldActive: false,
      shieldTimer: 0,
    };

    let obstacles = [];
    let powerUps = [];
    let obstacleSpeed = 3;
    let obstacleSpawnInterval = 1500;
    let lastObstacleSpawn = 0;
    let score = 0;
    let gameOver = false;
    let animationFrameId;

    let moveSoundPlaying = false;
    let soundOn = true;

    // Background stars for animation
    const stars = [];
    for(let i=0; i<100; i++) {
      stars.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        size: Math.random()*2+1,
        speed: Math.random()*0.5+0.2
      });
    }

    // ==== Utility functions ====

    function playMoveSound() {
      if (!moveSoundPlaying && soundOn) {
        moveSound.loop = true;
        moveSound.play();
        moveSoundPlaying = true;
      }
    }
    function stopMoveSound() {
      moveSound.pause();
      moveSound.currentTime = 0;
      moveSoundPlaying = false;
    }
    function playCollisionSound() {
      if (soundOn) collisionSound.play();
    }
    function playPowerupSound() {
      if (soundOn) powerupSound.play();
    }
    function playShieldSound() {
      if (soundOn) shieldSound.play();
    }
    function playNukeSound() {
      if (soundOn) nukeSound.play();
    }
    function playSlowSound() {
      if (soundOn) slowSound.play();
    }

    // ==== Input Handlers ====

    function keyDownHandler(e) {
      if (gameOver) return;
      if (e.key === 'ArrowLeft') {
        player.dx = -player.speed;
        playMoveSound();
      }
      else if (e.key === 'ArrowRight') {
        player.dx = player.speed;
        playMoveSound();
      }
    }
    function keyUpHandler(e) {
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
        player.dx = 0;
        stopMoveSound();
      }
    }

    // Mobile button handlers
    leftBtn.addEventListener('touchstart', e => {
      e.preventDefault();
      player.dx = -player.speed;
      playMoveSound();
    });
    leftBtn.addEventListener('touchend', e => {
      e.preventDefault();
      player.dx = 0;
      stopMoveSound();
    });
    rightBtn.addEventListener('touchstart', e => {
      e.preventDefault();
      player.dx = player.speed;
      playMoveSound();
    });
    rightBtn.addEventListener('touchend', e => {
      e.preventDefault();
      player.dx = 0;
      stopMoveSound();
    });

    // Sound toggle
    soundToggle.addEventListener('click', () => {
      soundOn = !soundOn;
      if (!soundOn) {
        stopMoveSound();
        soundToggle.textContent = 'üîà Unmute';
      } else {
        soundToggle.textContent = 'üîä Mute';
      }
    });

    // ==== Game Functions ====

    // Background theme colors by score ranges
    function getBackgroundTheme(score) {
      if(score < 500) return '#111'; // dark space
      if(score < 1000) return '#001f3f'; // neon blue
      return '#660000'; // glowing red
    }

    // Move player with boundary check
    function movePlayer() {
      player.x += player.dx;
      if (player.x < 0) player.x = 0;
      if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

      player.displayX += (player.x - player.displayX) * 0.2;

      if(player.speedBoostActive) {
        player.speedBoostTimer -= 16;
        if(player.speedBoostTimer <= 0) {
          player.speedBoostActive = false;
          player.speed = 7;
        }
      }

      if(player.shieldActive) {
        player.shieldTimer -= 16;
        if(player.shieldTimer <= 0) {
          player.shieldActive = false;
        }
      }
    }

    // Draw player with glow and shield ring if active
    function drawPlayer() {
      ctx.fillStyle = player.speedBoostActive ? '#00ffff' : '#00ff00';
      ctx.shadowColor = player.speedBoostActive ? '#00ffff' : '#00ff00';
      ctx.shadowBlur = 15;
      ctx.fillRect(player.displayX, player.y, player.width, player.height);
      ctx.shadowBlur = 0;

      // Draw shield ring if active
      if(player.shieldActive) {
        ctx.strokeStyle = '#00ffff';
        ctx.lineWidth = 4;
        ctx.shadowColor = '#00ffff';
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.arc(player.displayX + player.width/2, player.y + player.height/2, player.width, 0, Math.PI*2);
        ctx.stroke();
        ctx.shadowBlur = 0;
      }
    }

    // Spawn obstacles with optional movement
    function spawnObstacle() {
      const size = Math.random() * 20 + 20;
      const x = Math.random() * (canvas.width - size);
      // 50% chance to have moving obstacle
      const moving = Math.random() < 0.5;
      obstacles.push({ x, y: -size, width: size, height: size, opacity: 0, opacitySpeed: 0.05, moving, direction: 1, moveSpeed: 2 });
    }

    // Spawn power-ups with types: speed, shield, nuke, slow
    function spawnPowerUp() {
      const size = 25;
      const x = Math.random() * (canvas.width - size);
      const types = ['speed', 'shield', 'nuke', 'slow'];
      const type = types[Math.floor(Math.random() * types.length)];
      powerUps.push({ x, y: -size, width: size, height: size, opacity: 0, opacitySpeed: 0.05, type });
    }

    // Move obstacles, including side to side if moving
    function moveObstacles() {
      obstacles.forEach(obs => {
        obs.y += obstacleSpeed;
        if (obs.opacity < 1) obs.opacity += obs.opacitySpeed;

        if(obs.moving) {
          obs.x += obs.moveSpeed * obs.direction;
          if(obs.x < 0 || obs.x + obs.width > canvas.width) {
            obs.direction *= -1;
            obs.x = Math.min(Math.max(obs.x, 0), canvas.width - obs.width);
          }
        }
      });
      obstacles = obstacles.filter(obs => obs.y < canvas.height + obs.height);
    }

    // Move power-ups downward
    function movePowerUps() {
      powerUps.forEach(pu => {
        pu.y += obstacleSpeed * 0.8;
        if (pu.opacity < 1) pu.opacity += pu.opacitySpeed;
      });
      powerUps = powerUps.filter(pu => pu.y < canvas.height + pu.height);
    }

    // Draw obstacles (red pulsating squares)
    function drawObstacles() {
      obstacles.forEach(obs => {
        const pulse = 1 + 0.1 * Math.sin(Date.now() / 200);
        const w = obs.width * pulse;
        const h = obs.height * pulse;
        ctx.globalAlpha = obs.opacity;
        ctx.fillStyle = 'red';
        ctx.fillRect(obs.x - (w - obs.width) / 2, obs.y - (h - obs.height) / 2, w, h);
        ctx.globalAlpha = 1;
      });
    }

    // Draw power-ups with icons/colors by type
    function drawPowerUps() {
      powerUps.forEach(pu => {
        const pulse = 1 + 0.15 * Math.sin(Date.now() / 150);
        const size = pu.width * pulse;
        ctx.globalAlpha = pu.opacity;

        if(pu.type === 'speed') {
          ctx.fillStyle = '#0ff'; // cyan lightning bolt
          ctx.beginPath();
          ctx.moveTo(pu.x + size/2, pu.y);
          ctx.lineTo(pu.x + size*0.7, pu.y + size*0.7);
          ctx.lineTo(pu.x, pu.y + size*0.25);
          ctx.lineTo(pu.x + size, pu.y + size*0.25);
          ctx.lineTo(pu.x + size*0.3, pu.y + size*0.7);
          ctx.closePath();
          ctx.fill();
        } else if(pu.type === 'shield') {
          ctx.strokeStyle = '#00ffff';
          ctx.lineWidth = 4;
          ctx.beginPath();
          ctx.arc(pu.x + pu.width/2, pu.y + pu.height/2, pu.width/2, 0, Math.PI*2);
          ctx.stroke();
        } else if(pu.type === 'nuke') {
          ctx.fillStyle = '#ff0'; // yellow circle with X
          ctx.beginPath();
          ctx.arc(pu.x + pu.width/2, pu.y + pu.height/2, pu.width/2, 0, Math.PI*2);
          ctx.fill();
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(pu.x + pu.width*0.3, pu.y + pu.height*0.3);
          ctx.lineTo(pu.x + pu.width*0.7, pu.y + pu.height*0.7);
          ctx.moveTo(pu.x + pu.width*0.7, pu.y + pu.height*0.3);
          ctx.lineTo(pu.x + pu.width*0.3, pu.y + pu.height*0.7);
          ctx.stroke();
        } else if(pu.type === 'slow') {
          ctx.fillStyle = '#f0f'; // purple clock icon
          ctx.beginPath();
          ctx.arc(pu.x + pu.width/2, pu.y + pu.height/2, pu.width/2, 0, Math.PI*2);
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(pu.x + pu.width/2, pu.y + pu.height/3);
          ctx.lineTo(pu.x + pu.width/2, pu.y + pu.height/2);
          ctx.lineTo(pu.x + pu.width*0.65, pu.y + pu.height/2);
          ctx.stroke();
        }

        ctx.globalAlpha = 1;
      });
    }

    // Collision detection helper
    function checkCollision(rect1, rect2) {
      return (
        rect1.displayX < rect2.x + rect2.width &&
        rect1.displayX + rect1.width > rect2.x &&
        rect1.y < rect2.y + rect2.height &&
        rect1.height + rect1.y > rect2.y
      );
    }

    // Handle collisions with obstacles and power-ups
    function detectCollisions() {
      for (let i = 0; i < obstacles.length; i++) {
        if (checkCollision(player, obstacles[i])) {
          if(player.shieldActive) {
            // Shield absorbs hit
            playShieldSound();
            player.shieldActive = false;
            obstacles.splice(i,1);
            continue;
          } else {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†play
